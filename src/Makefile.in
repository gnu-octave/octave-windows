MKOCTFILE ?= @MKOCTFILE@
OCTAVE_CONFIG := @OCTAVE_CONFIG@
GREP ?= @GREP@
DEFS = @DEFS@
OLELIBS = @OLELIBS@

%.o: %.cc ; $(MKOCTFILE) -c $< $(DEFS)

PROGS=grab.oct win32api.oct __COM__.oct # ../inst/BROWER.m ../inst/image.m

ifeq ("@PKGWINQUERYREGFUNC@","winqueryreg")
  PROGS += winqueryreg.oct
endif

PROGS += winopen.oct
PROGS += clipboard.oct

ARCHTESTS = archtests
ARCHDIR   := "$(shell $(OCTAVE_CONFIG) -p CANONICAL_HOST_TYPE)-$(shell $(OCTAVE_CONFIG) -p API_VERSION)"

CC_SOURCES  := $(patsubst %.oct,%.cc,$(PROGS))
CC_TST_SOURCES := $(shell $(GREP) --files-with-matches '^%!' $(CC_SOURCES))
TST_SOURCES := $(patsubst %.cc,../inst/$(ARCHDIR)/%.cc-tst,$(CC_TST_SOURCES))

all: $(PROGS) $(ARCHTESTS)
	
grab.oct: grab.o grab_win32part.o
	$(MKOCTFILE) -o $@ $^

win32api.oct: win32api.o win32api_win32part.o
	$(MKOCTFILE) -o $@ $^ $(OLELIBS)

winqueryreg.oct: winqueryreg.o win32api_win32part.o
	$(MKOCTFILE) -o $@ $^ $(OLELIBS)

winopen.oct: winopen.o win32api_win32part.o
	$(MKOCTFILE) -o $@ $^ $(OLELIBS)

clipboard.oct: clipboard.o
	$(MKOCTFILE) -o $@ $^ $(OLELIBS)

__COM__.oct: __COM__.o
	$(MKOCTFILE) -o $@ $^ $(OLELIBS)

../inst/%.m : %.m.in
	if [ ! -d ../inst ]; then mkdir ../inst; fi
	cp $< $@

.PHONY: archtests
archtests: $(TST_SOURCES)

../inst/$(ARCHDIR):
	@mkdir -p "$@"

../inst/$(ARCHDIR)/%.cc-tst: %.cc | ../inst/$(ARCHDIR)
	@echo "Extracting tests from $< ..."
	@$(RM) -f "$@" "$@-t"
	@(      echo "## Generated from $<"; \
	        $(GREP) '^%!' "$<") > "$@"

clean: ; -rm -f *.o core octave-core *.oct *~
	test -e ../inst/$(ARCHDIR) && rm -f $(TST_SOURCES) || true
	test -e ../inst/$(ARCHDIR) && rmdir ../inst/$(ARCHDIR) || true
